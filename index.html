<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ­ í•‘ê¸€ê¸€ V29</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Jua&family=Gowun+Dodum:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root { --pink: #ffafcc; --blue: #a2d2ff; --yellow: #ffde59; --mint: #b9fbc0; --red: #ff4d4d; --gray: #d1d8e0; --dark: #1e272e; }
        * { font-family: 'Gowun Dodum', sans-serif; box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; }
        body { background: #fdfdfd; height: 100vh; display: flex; flex-direction: column; overflow: hidden; color: #000; transition: 0.5s; }
        
        /* Header */
        #top-banner { background: #000; color: #fff; padding: 12px; text-align: center; border-bottom: 4px solid var(--yellow); font-family: 'Jua'; font-size: 16px; flex-shrink: 0; z-index: 10; }
        
        /* Main Layout */
        #wrapper { flex: 1; display: flex; overflow: hidden; }
        
        /* Sidebar */
        #sidebar { width: 280px; background: #fff; border-right: 2px solid #eee; display: flex; flex-direction: column; padding: 10px; flex-shrink: 0; }
        #user-list { flex: 1; overflow-y: auto; }
        .user-tag { padding: 10px; border: 2px solid #eee; border-radius: 15px; margin-bottom: 6px; display: flex; align-items: center; gap: 8px; font-size: 13px; font-weight: bold; background: #fff; cursor: grab; }
        .user-tag.active-turn { border: 3px solid var(--pink); background: #fff0f5; }
        .user-tag.is-dead { background: #f0f0f0 !important; opacity: 0.6; color: #888; border-color: #ccc; filter: grayscale(1); }
        .user-tag.is-dead b { text-decoration: line-through; }

        /* Game Area */
        #game-view { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; align-items: center; background: #f8f9fa; }
        .game-card { background: #fff; width: 100%; max-width: 800px; padding: 20px; border-radius: 30px; border: 4px solid #000; min-height: 550px; position: relative; box-shadow: 8px 8px 0 rgba(0,0,0,0.05); }
        
        /* Board */
        #board { display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px; margin-top: 10px; }
        .tile { aspect-ratio: 1; border: 2px solid #000; border-radius: 12px; font-size: 14px; font-weight: bold; background: #fff; position: relative; display: flex; align-items: center; justify-content: center; text-align: center; padding: 5px; cursor: pointer; }
        .piece-container { position: absolute; inset: 0; display: flex; flex-wrap: wrap; align-items: flex-end; justify-content: center; padding: 4px; pointer-events: none; gap: 3px; }
        .piece { width: 16px; height: 16px; border-radius: 50%; border: 2px solid #000; position: relative; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .piece-name { position: absolute; bottom: 110%; left: 50%; transform: translateX(-50%); font-size: 8px; background: #000; color: #fff; padding: 2px 4px; border-radius: 3px; white-space: nowrap; }

        /* Chat Area */
        #chat-view { width: 320px; border-left: 2px solid #eee; display: flex; flex-direction: column; background: #fff; flex-shrink: 0; }
        #messages { flex: 1; overflow-y: auto; padding: 12px; display: flex; flex-direction: column; gap: 6px; background: #fafafa; }
        .msg { padding: 8px 12px; border-radius: 15px; font-size: 13px; max-width: 85%; border: 1.5px solid #ddd; background: #fff; position: relative; }
        .msg.sys { background: var(--yellow); border: 2px solid #000; align-self: center; font-size: 11px; font-weight: bold; }

        /* Responsive */
        @media (max-width: 900px) {
            #wrapper { flex-direction: column; }
            #sidebar { width: 100%; height: 140px; border-right: none; border-bottom: 2px solid #eee; }
            #chat-view { width: 100%; height: 240px; border-left: none; border-top: 2px solid #eee; }
            #board { grid-template-columns: repeat(4, 1fr); }
            .tile { font-size: 12px; }
        }

        /* Common Elements */
        button { border: 2.5px solid #000; border-radius: 12px; padding: 8px 12px; font-family: 'Jua'; font-size: 14px; cursor: pointer; background: #fff; transition: 0.2s; }
        button:active { transform: scale(0.95); }
        .btn-y { background: var(--yellow); } .btn-b { background: var(--blue); } .btn-r { background: var(--red); color: #fff; }
        input { border: 2.5px solid #000; padding: 8px; border-radius: 10px; font-size: 14px; }
        .game-section { display: none; flex-direction: column; height: 100%; }
        .game-section.active { display: flex; }
        
        .night-mode { background: var(--dark) !important; color: #fff !important; }
        .night-mode .game-card, .night-mode #sidebar, .night-mode #chat-view { background: #2d3436 !important; border-color: #636e72; color: #fff !important; }
        .night-mode .tile, .night-mode .user-tag, .night-mode .msg { background: #353b48 !important; border-color: #7f8c8d; color: #fff !important; }

        #login-screen { position: fixed; inset: 0; background: var(--pink); z-index: 2000; display: flex; align-items: center; justify-content: center; padding: 20px; }
    </style>
</head>
<body>

<div id="top-banner">ğŸ­ ROOM: <span id="room-code-tag">-</span> | <span id="now-user" style="color:var(--yellow)">ëŒ€ê¸°</span>ì˜ ì°¨ë¡€</div>

<div id="wrapper">
    <aside id="sidebar">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
            <span class="jua" style="font-size:16px;">ğŸ‘¥ ë©¤ë²„ ìˆœì„œ</span>
            <button onclick="changeNickPrompt()" style="font-size:11px; padding:4px 8px;">ë‹‰ë„¤ì„ ë³€ê²½</button>
        </div>
        <div id="user-list"></div>
        <div id="master-ctrl" style="display:none; margin-top:5px; padding-top:8px; border-top:3px solid #000;">
            <div style="display:grid; grid-template-columns:repeat(3, 1fr); gap:4px; margin-bottom:5px;">
                <button onclick="setMode('dice')" style="font-size:11px;">ğŸ²ë³´ë“œ</button>
                <button onclick="setMode('image')" style="font-size:11px;">ğŸ–¼ï¸ì§€ëª©</button>
                <button onclick="setMode('vote')" style="font-size:11px;">ğŸ™‹ë¬¸ë‹µ</button>
                <button onclick="setMode('king')" style="font-size:11px;">ğŸ‘‘ì™•</button>
                <button onclick="setMode('shop')" style="font-size:11px;">ğŸ›ï¸ì‡¼í•‘</button>
                <button onclick="setMode('mafia')" style="font-size:11px;">ğŸ•µï¸ë§ˆí”¼ì•„</button>
            </div>
            <button class="btn-b" onclick="nextTurn()" style="width:100%; margin-bottom:4px; font-size:12px;">â© ë‹¤ìŒ ìˆœì„œ ë„˜ê¸°ê¸°</button>
            <button class="btn-r" onclick="fullReset()" style="width:100%; font-size:12px;">ğŸ§¹ ëª¨ë“  ê¸°ë¡/ì±„íŒ… ì´ˆê¸°í™”</button>
        </div>
    </aside>

    <main id="game-view">
        <div class="game-card">
            <section id="sec-dice" class="game-section active">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <h2 class="jua" style="font-size:20px;">ğŸ² ì£¼ì‚¬ìœ„ ë³´ë“œ</h2>
                    <div id="dice-res" style="border:4px solid #000; width:50px; height:50px; display:flex; align-items:center; justify-content:center; border-radius:12px; font-weight:bold; background:var(--yellow); font-size:24px;">?</div>
                    <button class="btn-y" onclick="rollDice()">ì£¼ì‚¬ìœ„ êµ´ë¦¬ê¸°</button>
                </div>
                <div id="board"></div>
            </section>

            <section id="sec-image" class="game-section">
                <h2 class="jua" style="font-size:20px;">ğŸ–¼ï¸ ì´ë¯¸ì§€ ê²Œì„</h2>
                <div id="img-topic-box" style="padding:20px; border:4px solid #000; border-radius:20px; background:var(--pink); text-align:center; margin:15px 0; font-weight:bold; font-size:18px;">ì£¼ì œ ëŒ€ê¸° ì¤‘</div>
                <div id="img-vote-grid" style="display:grid; grid-template-columns:1fr 1fr; gap:8px;"></div>
                <div style="text-align:center; margin-top:10px;"><button class="btn-r" onclick="cancelVote()" id="btn-cancel-vote" style="display:none;">ì§€ëª© ì·¨ì†Œ âŒ</button></div>
                <div id="master-img-panel" style="display:none; margin-top:15px;"><input type="text" id="img-in" placeholder="íˆ¬í‘œ ì£¼ì œ..." style="width:65%;"><button class="btn-y" onclick="sendImgTopic()">ë°°í¬</button><button class="btn-r" onclick="revealImgResult()">ê²°ê³¼ê³µê°œ</button></div>
            </section>

            <section id="sec-vote" class="game-section">
                <h2 class="jua" style="font-size:20px;">ğŸ™‹ ìƒí™© ë¬¸ë‹µ</h2>
                <div id="vote-topic" style="padding:15px; border:3px solid #000; border-radius:15px; background:var(--mint); margin-bottom:15px; font-weight:bold;">ëŒ€ê¸° ì¤‘...</div>
                <div id="ans-list" style="flex:1; overflow-y:auto; margin-bottom:10px; display:flex; flex-direction:column; gap:8px;"></div>
                <div style="display:flex; gap:5px;"><input type="text" id="ans-in" style="flex:1;" placeholder="ë‹µë³€ ì…ë ¥..."><button class="btn-b" onclick="submitAns()">ì œì¶œ</button></div>
                <div id="master-vote-panel" style="display:none; margin-top:10px;"><input type="text" id="topic-in" placeholder="ìƒí™© ì œì‹œ" style="width:75%"><button class="btn-y" onclick="sendTopic()">ë°°í¬</button></div>
            </section>

            <section id="sec-king" class="game-section">
                <h2 class="jua" style="font-size:20px;">ğŸ‘‘ ì™•ê²Œì„</h2>
                <div id="king-display" style="text-align:center; padding:40px 20px;">
                    <div class="jua" style="font-size:24px; color:var(--red); margin-bottom:10px;">í˜„ì¬ì˜ ì™•</div>
                    <div id="king-name" class="jua" style="font-size:40px; background:var(--yellow); display:inline-block; padding:10px 30px; border:4px solid #000; border-radius:20px;">-</div>
                    <div id="king-cmd" class="jua" style="margin-top:30px; font-size:22px; line-height:1.5;">ëª…ë ¹ì„ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...</div>
                </div>
                <div id="master-king-panel" style="display:none; text-align:center;"><input type="text" id="king-in" placeholder="ì™•ì˜ ëª…ë ¹ ì…ë ¥" style="width:80%; margin-bottom:10px;"><br><button class="btn-b" onclick="sendKingCmd()">ëª…ë ¹ í•˜ë‹¬í•˜ê¸°</button></div>
            </section>

            <section id="sec-shop" class="game-section">
                <h2 class="jua" style="font-size:20px;">ğŸ›ï¸ ë¸”ë¼ì¸ë“œ í™ˆì‡¼í•‘</h2>
                <div id="shop-view" class="jua" style="font-size:24px; padding:60px 20px; border:4px dashed #000; text-align:center; border-radius:30px; background:#fff; margin:20px 0;">?</div>
                <div id="master-shop-panel" style="display:none; text-align:center;">
                    <input type="text" id="shop-item-in" placeholder="íŒë§¤ ë¬¼ê±´ ë¹„ë°€ ì„¤ì •" style="width:70%; margin-bottom:10px;"><br>
                    <button class="btn-r" onclick="setShopItem()">ë¬¼ê±´ ì£¼ì…</button>
                    <button class="btn-b" onclick="revealShop()">ì •ì²´ ê³µê°œ!</button>
                </div>
            </section>

            <section id="sec-mafia" class="game-section">
                <h2 class="jua" id="mafia-state" style="font-size:24px;">â˜€ï¸ ë‚®</h2>
                <div id="my-job" class="jua" style="font-size:18px; margin:15px 0; color:var(--blue); text-align:center;">ì§ì—… í™•ì¸ ì¤‘...</div>
                <div id="mafia-btns" style="display:grid; grid-template-columns:1fr 1fr; gap:8px;"></div>
                <div id="police-note" style="margin-top:15px; font-weight:bold; color:var(--red); text-align:center; font-size:15px;"></div>
                <div id="master-mafia-panel" style="display:none; margin-top:20px; border-top:3px solid #000; padding-top:15px;">
                    <button class="btn-r" onclick="assignJobs()" style="width:100%; margin-bottom:8px;">ì§ì—… ë¬´ì‘ìœ„ ë°°ì •</button>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
                        <button class="btn-b" onclick="toggleNight('night')">ğŸŒ™ ë°¤ì´ ë˜ì—ˆìŠµë‹ˆë‹¤</button>
                        <button class="btn-y" onclick="processMafia()">â˜€ï¸ ë‚®ì´ ë˜ì—ˆìŠµë‹ˆë‹¤</button>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <aside id="chat-view">
        <div id="messages"></div>
        <div id="reply-preview" style="display:none; padding:8px; background:var(--gray); font-size:11px; position:relative; border-top:2px solid #000;">
            <span id="reply-text"></span> <button onclick="cancelReply()" style="position:absolute; right:8px; top:4px;">X</button>
        </div>
        <div style="padding:10px; border-top:1px solid #eee; display:flex; gap:5px;">
            <input type="text" id="chat-in" style="flex:1;" placeholder="ë©”ì‹œì§€..." onkeypress="if(event.keyCode==13) sendChat()">
            <button class="btn-b" onclick="sendChat()">ì „ì†¡</button>
        </div>
    </aside>
</div>

<div id="login-screen">
    <div style="background:#fff; padding:35px; border-radius:35px; border:5px solid #000; width:100%; max-width:360px; text-align:center;">
        <h1 class="jua" style="color:var(--pink); font-size:40px; margin-bottom:10px;">ğŸ­ í•‘ê¸€ê¸€ V29</h1>
        <p style="font-weight:bold; margin-bottom:20px; font-size:14px;">ì‹¤ì‹œê°„ ë©€í‹° ë³´ë“œê²Œì„ í”Œë«í¼</p>
        <input type="text" id="nick-in" placeholder="ë‚´ ë‹‰ë„¤ì„" style="width:100%; margin-bottom:8px;">
        <input type="text" id="room-in" placeholder="ë°© ì½”ë“œ ì…ë ¥" style="width:100%; margin-bottom:20px;">
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
            <button class="btn-y" onclick="join('host')">ë°© ë§Œë“¤ê¸°</button>
            <button class="btn-b" onclick="join('member')">ì°¸ì—¬í•˜ê¸°</button>
        </div>
    </div>
</div>

<audio id="snd-bubble" src="https://assets.mixkit.co/active_storage/sfx/1999/1999-preview.mp3"></audio>
<audio id="snd-click" src="https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3"></audio>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyAe6e4W_pTEuW0Uh9yTY_i-34M9LDPowOg",
        authDomain: "gamebbi.firebaseapp.com",
        databaseURL: "https://gamebbi-default-rtdb.firebaseio.com",
        projectId: "gamebbi",
        storageBucket: "gamebbi.firebasestorage.app",
        messagingSenderId: "949538355839",
        appId: "1:949538355839:web:0aa1b91e9749de70e41d4a"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let roomRef, myNick, myKey, myRole, currentMode, turnOrder = [], replyTarget = null;
    const userColors = ["#ffafcc", "#a2d2ff", "#ffde59", "#b9fbc0", "#ff4d4d", "#cdb4db", "#fb8500", "#00b4d8"];
    const sndBubble = document.getElementById('snd-bubble');
    const sndClick = document.getElementById('snd-click');

    function join(role) {
        myNick = document.getElementById('nick-in').value.trim();
        let roomCode = document.getElementById('room-in').value.trim();
        if(!myNick || !roomCode) return alert("ë‹‰ë„¤ì„ê³¼ ë°© ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!");
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('room-code-tag').innerText = roomCode;
        roomRef = db.ref('rooms/' + roomCode);
        
        const userRef = roomRef.child('users').push();
        myKey = userRef.key;
        if(role === 'host') {
            roomRef.update({ hostKey: myKey, currentGame: 'dice', turnIdx: 0, boardData: Array(19).fill("ë²Œì¹™!").concat("ğŸš©ë„ì°©") });
            initSortable();
        }
        
        userRef.update({ nick: myNick, pos: 0, dead: false, job: "ì‹œë¯¼", id: myKey, color: userColors[Math.floor(Math.random()*userColors.length)] });
        userRef.onDisconnect().remove();
        sendChat(`ğŸ‘‹ [${myNick}]ë‹˜ì´ ì…ì¥í•˜ì…¨ìŠµë‹ˆë‹¤.`, true);
        listen();
    }

    function changeNickPrompt() {
        const n = prompt("ë³€ê²½í•  ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”:");
        if(n && n.trim()) { roomRef.child('users').child(myKey).update({ nick: n.trim() }); myNick = n.trim(); sendChat(`âœ¨ ë‹‰ë„¤ì„ ë³€ê²½: [${n}]`, true); sndClick.play(); }
    }

    function initSortable() {
        new Sortable(document.getElementById('user-list'), {
            animation: 150, onEnd: () => {
                const newOrder = Array.from(document.querySelectorAll('.user-tag')).map(el => el.dataset.key);
                roomRef.update({ order: newOrder });
            }
        });
    }

    function listen() {
        roomRef.on('value', snap => {
            const d = snap.val(); if(!d) return;
            const isMaster = d.hostKey === myKey;
            document.getElementById('master-ctrl').style.display = isMaster ? 'block' : 'none';
            document.querySelectorAll('[id*="master-"]').forEach(el => el.style.display = isMaster ? 'block' : 'none');

            if(currentMode !== d.currentGame) {
                currentMode = d.currentGame;
                document.querySelectorAll('.game-section').forEach(s => s.classList.remove('active'));
                document.getElementById('sec-' + currentMode).classList.add('active');
            }
            if(d.users) {
                turnOrder = d.order || Object.keys(d.users);
                const activeKey = turnOrder[d.turnIdx || 0];
                const activeNick = d.users[activeKey]?.nick || "ëŒ€ê¸°";
                document.getElementById('now-user').innerText = activeNick;
                renderUsers(d.users, d.turnIdx, d.hostKey);
                if(currentMode === 'dice') renderBoard(d.users, d.boardData, activeKey, isMaster);
                if(currentMode === 'vote') renderAnsList(d.answers || {}, activeNick, d.bestAns);
                if(currentMode === 'image') renderImgVotes(turnOrder, d.votes || {}, d.imgReveal, d.users);
                if(currentMode === 'mafia') renderMafiaBtns(d.users[myKey], Object.values(d.users), d.isNight);
                document.getElementById('king-name').innerText = activeNick;
                document.getElementById('king-cmd').innerText = d.kingCmd || "ëª…ë ¹ì„ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...";
                document.getElementById('my-job').innerText = `ë‚´ ì§ì—…: [${d.users[myKey]?.job}]` + (d.users[myKey]?.dead ? " (ì‚¬ë§/íšŒìƒ‰)" : "");
                if(d.shopReveal) document.getElementById('shop-view').innerHTML = d.shopReveal;
                else document.getElementById('shop-view').innerText = "?";
            }
            document.body.className = d.isNight ? "night-mode" : "";
            document.getElementById('mafia-state').innerText = d.isNight ? "ğŸŒ™ ë°¤" : "â˜€ï¸ ë‚®";
            document.getElementById('dice-res').innerText = d.diceRes || "?";
            document.getElementById('vote-topic').innerText = d.voteTopic || "ìƒí™© ëŒ€ê¸° ì¤‘...";
            document.getElementById('img-topic-box').innerText = d.imgTopic ? `[${d.imgTopic}]ì¸ ì‚¬ëŒ?` : "ì£¼ì œ ëŒ€ê¸° ì¤‘";
            document.getElementById('btn-cancel-vote').style.display = (d.votes && d.votes[myKey] && !d.imgReveal) ? 'inline-block' : 'none';
        });

        roomRef.child('chat').limitToLast(20).on('value', snap => {
            const area = document.getElementById('messages'); area.innerHTML = "";
            if(snap.val()) Object.entries(snap.val()).forEach(([id, m]) => {
                const dv = document.createElement('div'); dv.className = `msg ${m.system?'sys':''}`;
                dv.style.alignSelf = m.nick === myNick ? 'flex-end' : 'flex-start';
                let content = (m.system?'':`<b onclick="setReply('${m.nick}','${m.text}')" style="color:var(--blue); cursor:pointer;">${m.nick}</b><br>`);
                if(m.replyTo) content += `<div style="font-size:10px; opacity:0.6; border-left:2px solid #ccc; padding-left:4px; margin-bottom:3px;">â†©ï¸ ${m.replyTo.nick}: ${m.replyTo.text.substring(0,10)}..</div>`;
                dv.innerHTML = content + m.text; area.appendChild(dv);
            });
            area.scrollTop = area.scrollHeight;
        });
    }

    function renderUsers(userObj, activeIdx, hKey) {
        const area = document.getElementById('user-list'); area.innerHTML = "";
        turnOrder.forEach((key, i) => {
            const u = userObj[key]; if(!u) return;
            const dv = document.createElement('div');
            dv.className = `user-tag ${i === activeIdx ? 'active-turn' : ''} ${u.dead ? 'is-dead' : ''}`;
            dv.dataset.key = key;
            dv.innerHTML = `<div style="width:12px;height:12px;border-radius:50%;background:${u.color};border:2px solid #000;"></div> <b>${u.nick}</b> ${key===hKey?'ğŸ‘‘':''}`;
            if(myKey === hKey && key !== myKey) {
                const bBox = document.createElement('div'); bBox.style="margin-left:auto; display:flex; gap:3px;";
                const dBtn = document.createElement('button'); dBtn.innerText = u.dead ? "ë³µêµ¬" : "í•´ê³ "; dBtn.style="font-size:9px; padding:3px 6px;";
                dBtn.onclick = (e) => { e.stopPropagation(); roomRef.child('users').child(key).update({ dead: !u.dead }); sndClick.play(); };
                const kBtn = document.createElement('button'); kBtn.innerText = "ê°•í‡´"; kBtn.className="btn-r"; kBtn.style="font-size:9px; padding:3px 6px;";
                kBtn.onclick = (e) => { e.stopPropagation(); if(confirm("ê°•í‡´í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) roomRef.child('users').child(key).remove(); };
                bBox.append(dBtn, kBtn); dv.appendChild(bBox);
            }
            area.appendChild(dv);
        });
    }

    function renderBoard(userObj, bData, activeKey, isMaster) {
        const area = document.getElementById('board'); area.innerHTML = "";
        (bData || Array(20).fill("ë²Œì¹™")).forEach((text, i) => {
            const tile = document.createElement('div'); tile.className = "tile";
            tile.innerHTML = `<div style="font-size:13px;">${text}</div><span style="position:absolute;top:2px;left:4px;opacity:0.3;font-size:9px;">${i+1}</span>`;
            const pCont = document.createElement('div'); pCont.className = "piece-container";
            Object.values(userObj).filter(u => u.pos === i && !u.dead).forEach(u => {
                const p = document.createElement('div'); p.className = "piece"; p.style.background = u.color;
                p.innerHTML = `<div class="piece-name">${u.nick}</div>`;
                pCont.appendChild(p);
            });
            tile.appendChild(pCont);
            tile.onclick = () => {
                if(isMaster) {
                    const actNick = userObj[activeKey]?.nick || "í˜„ì¬ í„´ ìœ ì €";
                    if(confirm(`[${actNick}]ë‹˜ì„ ì´ ì¹¸ìœ¼ë¡œ ê°•ì œ ì´ë™ì‹œí‚¬ê¹Œìš”?`)) { 
                        roomRef.child('users').child(activeKey).update({ pos: i }); 
                        sendChat(`ğŸ“¢ ë§ˆìŠ¤í„°ê°€ [${actNick}]ë‹˜ì„ ${i+1}ë²ˆ ì¹¸ìœ¼ë¡œ ì†Œí™˜í–ˆìŠµë‹ˆë‹¤.`, true);
                    } else { 
                        const nt = prompt("ì¹¸ ë‚´ìš© ìˆ˜ì •:", text); if(nt) { bData[i]=nt; roomRef.update({boardData:bData}); } 
                    }
                }
            };
            area.appendChild(tile);
        });
    }

    function rollDice() {
        const v = Math.floor(Math.random()*6)+1;
        roomRef.update({ diceRes: v });
        roomRef.child('users').child(myKey).once('value', s => {
            if(s.val() && !s.val().dead) {
                const nPos = Math.min(s.val().pos + v, 19);
                roomRef.child('users').child(myKey).update({ pos: nPos });
                sendChat(`ğŸ² [${myNick}] ì£¼ì‚¬ìœ„ [${v}]! (${nPos+1}ë²ˆ ì¹¸ ë„ì°©)`, true);
            }
        });
        sndBubble.play();
    }

    function sendChat(t, sys=false) {
        const txt = t || document.getElementById('chat-in').value;
        if(txt) {
            const msgData = { nick: myNick, text: txt, system: sys };
            if(!sys && replyTarget) { msgData.replyTo = replyTarget; cancelReply(); }
            roomRef.child('chat').push(msgData); document.getElementById('chat-in').value="";
        }
    }
    function setReply(nick, text) { replyTarget={nick,text}; document.getElementById('reply-preview').style.display='block'; document.getElementById('reply-text').innerText=`${nick}ì—ê²Œ ë‹µê¸€ ì¤‘..`; }
    function cancelReply() { replyTarget=null; document.getElementById('reply-preview').style.display='none'; }
    
    function setMode(m) { roomRef.update({ currentGame: m, votes: {}, answers: {}, bestAns: "", kingCmd: "", shopReveal: "", hiddenItem: "" }); sndClick.play(); }
    function nextTurn() { roomRef.once('value', s => { roomRef.update({ turnIdx: (s.val().turnIdx + 1) % turnOrder.length, answers: {}, bestAns: "", votes: {}, imgReveal: false }); }); sndClick.play(); }
    function fullReset() { if(confirm("ëª¨ë“  ì±„íŒ…ê³¼ ê²Œì„ ë‚´ì—­ì„ ë¦¬ì…‹í• ê¹Œìš”?")) { roomRef.update({chat:{}, answers:{}, votes:{}, diceRes:"?", isNight:false, kingCmd:"", shopReveal:"", hiddenItem:""}); roomRef.child('users').once('value', s=>s.forEach(u=>roomRef.child('users').child(u.key).update({pos:0, dead:false}))); sendChat("ğŸ§¹ ì‹œìŠ¤í…œ: ë°©ì¥ì´ ëª¨ë“  ë‚´ì—­ì„ ì´ˆê¸°í™”í–ˆìŠµë‹ˆë‹¤.", true); sndClick.play(); } }
    
    // ìƒí™©ë¬¸ë‹µ
    function submitAns() { const t = document.getElementById('ans-in').value; if(t) { roomRef.child('answers').child(myNick).set({ text: t, reply: "" }); document.getElementById('ans-in').value=""; sndClick.play(); } }
    function sendTopic() { roomRef.update({ voteTopic: document.getElementById('topic-in').value, answers: {}, bestAns: "" }); sndClick.play(); }
    function renderAnsList(ans, king, best) {
        const area = document.getElementById('ans-list'); area.innerHTML = "";
        Object.entries(ans).forEach(([nick, data]) => {
            const dv = document.createElement('div'); dv.style = `padding:10px; background:#fff; border:2.5px solid ${nick===best?'var(--pink)':'#eee'}; border-radius:15px; position:relative; font-size:13px;`;
            dv.innerHTML = `<b>${nick}:</b> ${data.text}`;
            if(data.reply) dv.innerHTML += `<div style="background:var(--yellow); padding:5px; border-radius:8px; margin-top:5px; font-size:11px; border:1px solid #000;">ğŸ‘‘ ì™•ì˜ ë‹µê¸€: ${data.reply}</div>`;
            if(myNick === king) {
                const rBtn = document.createElement('button'); rBtn.innerText="ğŸ’¬"; rBtn.style="position:absolute;right:45px;top:5px;padding:3px;";
                rBtn.onclick=()=> { const r = prompt("ë‹µê¸€ì„ ì…ë ¥í•˜ì„¸ìš”:"); if(r) roomRef.child('answers').child(nick).update({ reply: r }); };
                const vBtn = document.createElement('button'); vBtn.innerText="ğŸ†"; vBtn.style="position:absolute;right:8px;top:5px;padding:3px;";
                vBtn.onclick=()=> { roomRef.update({ bestAns: nick }); sendChat(`ğŸ† [${king}]ì™•ì˜ ì„ íƒ: [${nick}]ë‹˜!`, true); };
                dv.append(rBtn, vBtn);
            }
            area.appendChild(dv);
        });
    }

    // ì´ë¯¸ì§€ ê²Œì„
    function renderImgVotes(order, votes, revealed, userObj) {
        const area = document.getElementById('img-vote-grid'); area.innerHTML = "";
        order.forEach(key => {
            const u = userObj[key]; if(!u || u.dead) return;
            const count = Object.values(votes).filter(v => v === key).length;
            const btn = document.createElement('button'); btn.className = "btn-y"; btn.style="font-size:13px;";
            btn.innerHTML = `${u.nick} ${revealed ? `(${count})` : ''}`;
            btn.onclick = () => { if(!revealed) { roomRef.child('votes').child(myKey).set(key); sndBubble.play(); } };
            area.appendChild(btn);
        });
    }
    function cancelVote() { roomRef.child('votes').child(myKey).remove(); sndClick.play(); }
    function sendImgTopic() { roomRef.update({ imgTopic: document.getElementById('img-in').value, votes: {}, imgReveal: false }); sndClick.play(); }
    function revealImgResult() { roomRef.update({ imgReveal: true }); sndBubble.play(); }

    // ì™•ê²Œì„ / í™ˆì‡¼í•‘
    function sendKingCmd() { roomRef.update({ kingCmd: document.getElementById('king-in').value }); sndClick.play(); }
    function setShopItem() { roomRef.update({ hiddenItem: document.getElementById('shop-item-in').value, shopReveal: "ğŸ“¦ ë¬¼ê±´ì´ ë„ì°©í–ˆìŠµë‹ˆë‹¤! ë­”ì§€ ëª¨ë¥¸ ì±„ ì¥ì‚¬í•˜ì„¸ìš”!" }); sndClick.play(); }
    function revealShop() { roomRef.once('value', s => { roomRef.update({ shopReveal: `ğŸ“¢ ë¬¼ê±´ì˜ ì •ì²´:<br><b style="color:var(--red); font-size:30px;">"${s.val().hiddenItem}"</b>` }); sndBubble.play(); }); }

    // ë§ˆí”¼ì•„
    function assignJobs() { 
        const j = prompt("ì§ì—…êµ° ì…ë ¥(ì½¤ë§ˆë¡œ êµ¬ë¶„):", "ë§ˆí”¼ì•„,ì˜ì‚¬,ê²½ì°°,ì‹œë¯¼,ì‹œë¯¼").split(',');
        roomRef.child('users').once('value', s => { let i=0; s.forEach(u => roomRef.child('users').child(u.key).update({ job: j[i++]||"ì‹œë¯¼", dead: false })); });
    }
    function toggleNight(type) { if(type==='night') { roomRef.update({ isNight: true, mafiaKill: "", doctorSave: "" }); sendChat("ğŸŒ™ ë°¤ì´ ë˜ì—ˆìŠµë‹ˆë‹¤. ëŠ¥ë ¥ì„ ì‚¬ìš©í•˜ì„¸ìš”.", true); } sndClick.play(); }
    function renderMafiaBtns(me, users, night) {
        const area = document.getElementById('mafia-btns'); area.innerHTML = "";
        if(!night || !me || me.dead) return;
        users.filter(u => !u.dead && u.id !== myKey).forEach(u => {
            const b = document.createElement('button'); b.className = "btn-b"; b.style="font-size:12px;";
            if(me.job==='ë§ˆí”¼ì•„') { b.innerText=`ì²˜ë‹¨: ${u.nick}`; b.onclick=()=> { roomRef.update({mafiaKill:u.id}); alert(u.nick+" ì„ íƒ"); } }
            else if(me.job==='ê²½ì°°') { b.innerText=`ì¡°ì‚¬: ${u.nick}`; b.onclick=()=> document.getElementById('police-note').innerText = `[${u.nick}]ë‹˜ì€ ${u.job==='ë§ˆí”¼ì•„'?'ğŸš¨ë§ˆí”¼ì•„':'âœ…ì‹œë¯¼'}ì…ë‹ˆë‹¤.`; }
            else if(me.job==='ì˜ì‚¬') { b.innerText=`ì¹˜ë£Œ: ${u.nick}`; b.onclick=()=> { roomRef.update({doctorSave:u.id}); alert(u.nick+" ì¹˜ë£Œ"); } }
            if(b.innerText) area.appendChild(b);
        });
    }
    function processMafia() {
        roomRef.once('value', s => { const d = s.val(); 
            let msg = "â˜€ï¸ ë‚®ì´ ë˜ì—ˆìŠµë‹ˆë‹¤. ";
            if(d.mafiaKill && d.mafiaKill !== d.doctorSave) { roomRef.child('users').child(d.mafiaKill).update({ dead: true }); msg += `[${d.users[d.mafiaKill].nick}]ë‹˜ì´ ì²˜ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.`; }
            else msg += "ì§€ë‚œ ë°¤ì—ëŠ” í‰í™”ë¡œì› ìŠµë‹ˆë‹¤.";
            sendChat(msg, true); roomRef.update({ isNight: false }); sndBubble.play();
        });
    }
</script>
</body>
</html>